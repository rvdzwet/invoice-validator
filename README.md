# Bouwdepot Invoice Validator Enhancements

This project has been enhanced with multi-modal validation and audit transparency features to make the invoice validation process more robust and transparent.

## Getting Started

### Prerequisites

- .NET SDK (version specified in `global.json` or latest)
- Node.js and npm (latest LTS recommended)

### Running in Development

1.  Open a PowerShell terminal in the root directory of the project.
2.  Run the script:
    ```powershell
    ./run-app.ps1
    ```
3.  This will start the .NET backend API, which now also serves the React frontend.
4.  Access the application at `https://localhost:7051` (or the port specified in `launchSettings.json`).
5.  The API Swagger documentation is available at `https://localhost:7051/swagger`.

### Publishing for Deployment

1.  Open a PowerShell terminal in the root directory of the project.
2.  Run the publish script:
    ```powershell
    ./publish-app.ps1
    ```
3.  This script will perform the following steps:
    - Install frontend dependencies (`npm install` in `BouwdepotInvoiceValidator.Client` if needed).
    - Build the React frontend for production (`npm run build:prod`), placing the static files into `BouwdepotInvoiceValidator/wwwroot`.
    - Publish the .NET backend application (`dotnet publish -c Release`), including the frontend files from `wwwroot`, into the `./publish` directory.
4.  The `./publish` directory will contain the complete application package ready for deployment.
5.  **IIS Deployment**:
    - The project now includes a `web.config` file, which is necessary for hosting in IIS. This file configures the ASP.NET Core Module (ANCM) to run the application.
    - Ensure the target server has the ASP.NET Core Hosting Bundle installed.
    - Create a new website or application in IIS Manager.
    - Point the physical path to the `./publish` directory generated by the script.
    - Configure the application pool (e.g., set .NET CLR version to 'No Managed Code' as ANCM runs the .NET runtime externally or in-process).

## Recent Updates

### Build Fixes (April 2025)

- Fixed service dependency issues in `GeminiServiceProxy` to properly reference the correct Gemini services
- Corrected namespace references for Gemini services to use the proper `Gemini` namespace
- Added missing `ExtractInvoiceDataFromImagesAsync` method to `GeminiAdvancedAnalysisService`
- Fixed property mapping in `GeminiAdvancedAnalysisService` to match the `Invoice` and `PaymentDetails` models
- Resolved type conversion issues between decimal and int values in line item processing
- Fixed dependency injection error by removing direct registration of abstract `GeminiServiceBase` class
- Enhanced `GeminiLineItemAnalysisService` to properly populate audit report fields
- Improved JSON parsing in `ParseAuditAssessmentResponse` with proper type conversions and fallback mechanism

### Dependency Injection Fixes (April 2025)

- Fixed dependency injection issues with `GeminiServiceBase` and `GeminiModelProvider`
- Properly registered `GeminiConversationService` as an implementation of `GeminiServiceBase`
- Updated `GeminiServiceProxy` to use the correct `Gemini.GeminiService` implementation
- Added explicit registration for `BouwdepotInvoiceValidator.Services.Gemini.GeminiService`
- Implemented factory pattern for `GeminiModelProvider` to ensure proper dependency resolution
- Fixed lifetime scope issue by changing `AIModelProviderFactory` and `GeminiModelProvider` from singleton to scoped services
- Removed caching of model provider in `UnifiedInvoiceValidationService` to prevent scoped service resolution from root provider

### Prompt Refactoring (April 2025)

- Split the large Gemini prompt for invoice data extraction (`BuildInvoiceDataExtractionPrompt`) into three smaller, more focused prompts:
    - `BuildInvoiceHeaderPrompt`: Extracts invoice number, dates, amounts, currency.
    - `BuildInvoicePartiesPrompt`: Extracts vendor and customer details.
    - `BuildInvoiceLineItemsPrompt`: Extracts line items, payment terms, notes.
- Updated `ExtractInvoiceDataFromImagesAsync` to use these new prompts and corresponding parsing methods (`ParseInvoiceHeaderResponse`, `ParseInvoicePartiesResponse`, `ParseInvoiceLineItemsResponse`).
- Improved the `BuildDocumentTypePrompt` to include more context (vendor name, total amount) for better document classification.

## New Features

### 1. Multi-Modal Validation

The application now uses both text and visual analysis to validate invoices:

- **Text Analysis**: Extracts and analyzes text content for home improvement-related keywords and patterns
- **Visual Analysis**: Examines the visual structure, layout, and elements of the invoice
- **Combined Assessment**: Cross-references both text and visual elements for consistency and signs of fraud

### 2. Audit-Ready Documentation

The validation process now produces comprehensive, audit-ready documentation:

- **Detailed Assessment Framework**: Clear evaluation criteria with weighted scoring
- **Evidence Collection**: Specific evidence for each criterion
- **Confidence Scoring**: Confidence metrics for different aspects of the assessment
- **Regulatory References**: Documentation of relevant Dutch regulations when applicable
- **Comprehensive Justification**: Detailed explanation of the decision process

### 3. Enhanced Fraud Detection

Improved fraud detection with:

- **Visual Anomaly Detection**: Detection of visual inconsistencies that might indicate tampering
- **Mathematical Verification**: Calculation checks for line items and totals
- **Missing Information Analysis**: Detection of missing critical legal elements

## Configuration Options

You can configure these features in the `appsettings.json` file:

```json
"Validation": {
  "UseMultiModalAnalysis": true,
  "GenerateAuditReadyResults": true
}
```

- **UseMultiModalAnalysis**: Enable/disable multi-modal validation (text + visual analysis)
- **GenerateAuditReadyResults**: Enable/disable comprehensive audit documentation

## User Interface Improvements

The UI now displays:

- **Audit Documentation**: Detailed explanation of the decision-making process
- **Criteria Assessment**: Breakdown of scores for different validation criteria (Legacy view)
- **Visual Assessment**: Results of the visual analysis of the invoice
- **Confidence Metrics**: Overall confidence score for the validation
- **Comprehensive Details**: The main validation view now displays a wider range of information returned by the API, including document analysis details, home improvement specifics, fraud detection results, and analysis timing.

## Implementation Details

### Text Analysis

The system uses enhanced prompts for Gemini AI to more accurately classify invoices:

- More detailed industry context for Dutch construction
- Specific guidance on home improvement vs. non-home improvement expenses
- Structured analysis with weighted criteria

### Visual Analysis

The visual analysis pipeline includes:

- Page image extraction from PDFs
- Layout and structure analysis
- Logo and signature detection
- Visual tampering detection
- Document inconsistency identification

### Multi-Modal Integration

The system combines text and visual analysis using:

- Cross-verification between text and visual elements
- Detection of contradictions between text content and visual elements
- Weighted scoring across both textual and visual criteria

## Future Improvements

Potential areas for further enhancement:

1. Advanced machine learning for tamper detection
2. Historical pattern analysis across submitted invoices
3. Integration with external KvK verification APIs
4. Price benchmarking against market rates
5. Integration with banking APIs to verify payments
